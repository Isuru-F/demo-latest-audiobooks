name: Amp PR Bot with Orb SDK

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

env:
  AMP_TOOLBOX: ${{ github.workspace }}/.tools

jobs:
  amp-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.sha }} --depth=1
          git fetch origin ${{ github.event.pull_request.head.sha }} --depth=1
          
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > pr_diff.txt
          
          if [ -s pr_diff.txt ]; then
            echo "HAS_DIFF=true" >> $GITHUB_OUTPUT
          else
            echo "HAS_DIFF=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.diff.outputs.HAS_DIFF == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.diff.outputs.HAS_DIFF == 'true'
        run: |
          # Install Orb SDK (includes Amp CLI)
          npm install @sourcegraph/the-orb-is-awake zod
          
          # Install tree-sitter dependencies for entity extraction
          npm install tree-sitter@0.20.4 tree-sitter-typescript@0.20.3 tree-sitter-javascript@0.21.2 || true
          
          # Ensure jq is available (should be pre-installed on ubuntu-latest)
          which jq || sudo apt-get update && sudo apt-get install -y jq

      - name: Extract entities and review with Orb SDK
        if: steps.diff.outputs.HAS_DIFF == 'true'
        env:
          AMP_API_KEY: ${{ secrets.AMP_API_KEY }}
        run: |
          # Create empty settings file for clean Amp environment
          echo '{}' > /tmp/empty-settings.json
          
          # Extract entities using toolbox
          echo "Extracting entities..."
          ENTITIES_JSON=$(echo "diff_content: $(cat pr_diff.txt)" | TOOLBOX_ACTION=execute ./.tools/extract-diff-entities)
          echo "$ENTITIES_JSON" > entities.json
          
          ENTITY_COUNT=$(echo "$ENTITIES_JSON" | jq '.entities_found')
          echo "Found $ENTITY_COUNT entities to review"
          
          if [ "$ENTITY_COUNT" -eq 0 ]; then
            echo '{"tool":"amp","version":"0.2","issues":[]}' > amp_review.json
            exit 0
          fi
          
          # Use Orb SDK for structured review with clean settings
          node ./.tools/review-with-orb.mjs

      - name: Create GitHub review comments
        if: steps.diff.outputs.HAS_DIFF == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AMP_REVIEW_GH_TOKEN }}
          script: |
            const fs = require('fs');

            function parseDiffFiles(diffContent) {
              const files = {};
              const lines = diffContent.split('\n');
              let currentFile = null;
              let oldLineNum = 0;
              let newLineNum = 0;
              let diffPosition = -1;

              for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                const fileMatch = line.match(/^diff --git a\/(.+) b\/(.+)$/);
                if (fileMatch) {
                  currentFile = fileMatch[2];
                  files[currentFile] = { lineMap: {}, diffHunks: [] };
                  diffPosition = -1;
                  continue;
                }

                if (line.startsWith('index ') || line.startsWith('new file') || 
                    line.startsWith('deleted file') || line.startsWith('--- ') || line.startsWith('+++ ')) {
                  continue;
                }

                const hunkMatch = line.match(/^@@ -(\d+),?\d* \+(\d+),?\d* @@/);
                if (hunkMatch && currentFile) {
                  oldLineNum = parseInt(hunkMatch[1]);
                  newLineNum = parseInt(hunkMatch[2]);
                  diffPosition++;
                  files[currentFile].diffHunks.push({ oldStart: oldLineNum, newStart: newLineNum, position: diffPosition });
                  continue;
                }

                if (currentFile && (line.startsWith('+') || line.startsWith('-') || line.startsWith(' '))) {
                  diffPosition++;
                  if (line.startsWith('+') && !line.startsWith('+++')) {
                    files[currentFile].lineMap[newLineNum] = { type: 'added', line: newLineNum, position: diffPosition, side: 'RIGHT' };
                    newLineNum++;
                  } else if (line.startsWith('-') && !line.startsWith('---')) {
                    oldLineNum++;
                  } else if (line.startsWith(' ')) {
                    files[currentFile].lineMap[newLineNum] = { type: 'context', line: newLineNum, position: diffPosition, side: 'RIGHT' };
                    oldLineNum++;
                    newLineNum++;
                  }
                }
              }

              return files;
            }

            let ampJson;
            try {
              const raw = fs.readFileSync('amp_review.json', 'utf8');
              ampJson = JSON.parse(raw);
            } catch (e) {
              console.log('Could not read amp_review.json:', e.message);
              return;
            }

            if (!ampJson.issues || !Array.isArray(ampJson.issues)) {
              console.log('No issues found in amp_review.json');
              return;
            }

            const diffContent = fs.readFileSync('pr_diff.txt', 'utf8');
            const diffFiles = parseDiffFiles(diffContent);
            
            const reviewComments = [];
            
            for (const issue of ampJson.issues) {
              const file = issue.file?.trim();
              const line = Number(issue.line);
              
              if (!file || !Number.isFinite(line) || !diffFiles[file]) continue;
              
              const fileData = diffFiles[file];
              let diffPosition = fileData.lineMap[line]?.position;
              
              if (!diffPosition && fileData.diffHunks.length > 0) {
                diffPosition = fileData.diffHunks[0].position + 1;
              }
              
              if (diffPosition) {
                const sevToTag = (sev) => {
                  if (sev === 'HIGH') return 'ðŸ”´ HIGH';
                  if (sev === 'LOW') return 'ðŸŸ¢ LOW';
                  return 'ðŸŸ¡ MEDIUM';
                };

                const priority = sevToTag(issue.severity);
                const suggestion = issue.suggestion ? `**Suggestion:** ${issue.suggestion}\n\n` : '';
                const body = `**${priority} - ${issue.title}**\n\n${issue.description}\n\n${suggestion}---\n* Generated by Amp Toolbox Review`;

                reviewComments.push({ path: file, position: diffPosition, body });
              }
            }

            if (reviewComments.length > 0) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: `## ðŸ§° Amp Toolbox Review\n\nFound **${reviewComments.length}** issues using toolbox analysis with thread reuse.\n\n---\n*Review completed on ${new Date().toISOString().split('T')[0]}*`,
                event: 'REQUEST_CHANGES',
                comments: reviewComments,
              });
            } else {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: `## ðŸ§° Amp Toolbox Review\n\nNo issues found. âœ…\n\n---\n*Review completed on ${new Date().toISOString().split('T')[0]}*`,
                event: 'COMMENT',
              });
            }

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: amp-review-artifacts
          path: |
            pr_diff.txt
            entities.json
            amp_review.json
            /tmp/empty-settings.json
          retention-days: 3
